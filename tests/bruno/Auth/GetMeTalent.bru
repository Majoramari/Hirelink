meta {
  name: GetMeTalent
  type: http
  seq: 6
}

get {
  url: {{base_url}}/auth/me
  body: none
  auth: inherit
}

headers {
  Authorization: Bearer {{talent_access_token}}
}

script:post-response {
  const profile = res.body?.data?.talentProfile;
  if (!profile) {
    throw new Error("Expected response to include data.talentProfile");
  }

  const skills = profile.skills;
  if (!Array.isArray(skills)) {
    throw new Error("Expected data.talentProfile.skills to be an array");
  }

	const expectedSkillIdRaw = bru.getEnvVar("skill_id");
	if (expectedSkillIdRaw) {
		let expectedSkillId;
		try {
			expectedSkillId = JSON.parse(expectedSkillIdRaw);
		} catch {
			expectedSkillId = expectedSkillIdRaw;
		}

		const found = skills.some((s) => s?.skillId === expectedSkillId);
		if (!found) {
			throw new Error(
				"Expected data.talentProfile.skills to include the env var skill_id",
			);
		}
	}

  for (const s of skills) {
    if (!s || typeof s !== "object") {
      throw new Error("Expected each skill to be an object");
    }
    if (!s.skillId || typeof s.skillId !== "string") {
      throw new Error("Expected each skill to have a string skillId");
    }
    if (!s.name || typeof s.name !== "string") {
      throw new Error("Expected each skill to have a string name");
    }
    if (!s.level || typeof s.level !== "string") {
      throw new Error("Expected each skill to have a string level");
    }
  }

	const certificates = profile.certificates;
	if (!Array.isArray(certificates)) {
		throw new Error("Expected data.talentProfile.certificates to be an array");
	}

	const expectedCertificateIdRaw = bru.getEnvVar("certificate_id");
	if (expectedCertificateIdRaw) {
		let expectedCertificateId;
		try {
			expectedCertificateId = JSON.parse(expectedCertificateIdRaw);
		} catch {
			expectedCertificateId = expectedCertificateIdRaw;
		}
		const found = certificates.some(
			(c) => c?.certificateId === expectedCertificateId,
		);
		if (!found) {
			throw new Error(
				"Expected data.talentProfile.certificates to include the env var certificate_id",
			);
		}

		const expectedCredentialIdRaw = bru.getEnvVar("certificate_credential_id");
		const expectedCredentialUrlRaw = bru.getEnvVar("certificate_credential_url");
		if (expectedCredentialIdRaw || expectedCredentialUrlRaw) {
			let expectedCredentialId = expectedCredentialIdRaw;
			let expectedCredentialUrl = expectedCredentialUrlRaw;
			try {
				if (expectedCredentialIdRaw) {
					expectedCredentialId = JSON.parse(expectedCredentialIdRaw);
				}
				if (expectedCredentialUrlRaw) {
					expectedCredentialUrl = JSON.parse(expectedCredentialUrlRaw);
				}
			} catch {
				// keep raw
			}

			const cert = certificates.find(
				(c) => c?.certificateId === expectedCertificateId,
			);
			if (!cert) {
				throw new Error("Expected certificate to exist");
			}
			if (expectedCredentialIdRaw && cert.credentialId !== expectedCredentialId) {
				throw new Error(
					"Expected certificate credentialId to match certificate_credential_id",
				);
			}
			if (
				expectedCredentialUrlRaw &&
				cert.credentialUrl !== expectedCredentialUrl
			) {
				throw new Error(
					"Expected certificate credentialUrl to match certificate_credential_url",
				);
			}
		}
	}
}

settings {
  encodeUrl: true
  timeout: 0
}
